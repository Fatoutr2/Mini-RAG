import { createContext, useContext, useEffect, useMemo, useState } from "react";

const STORAGE_KEY = "app_lang";

const messages = {
  fr: {
    menuToggle: "Ouvrir/Fermer le menu",
    rag: "RAG",
    chat: "Chat",
    darkMode: "Mode sombre",
    lightMode: "Mode clair",
    roleAdmin: "ADMIN",
    roleMember: "MEMBRE",
    language: "Langue",

    newChat: "Nouveau chat",
    creating: "CrÃ©ation...",
    searchChat: "Rechercher chat",
    yourChats: "VOS CHATS",
    rename: "Renommer",
    delete: "Supprimer",
    deleteChatConfirm: "Supprimer ce chat ?",
    newTitlePrompt: "Nouveau titre",
    uploadImpossible: "Upload impossible",
    uploadDoneIn: "Fichier dÃ©posÃ© dans",
    addFile: "Ajouter fichier",
    uploadProgress: "Upload...",
    logout: "DÃ©connexion",
    destinationPrompt: "Destination ? Tapez public ou private",
    destinationInvalid: "Destination invalide. Utilisez public ou private.",
    adminAccess: "AccÃ¨s",
    adminMembers: "Membres",
    adminAdmins: "Admins",

    loadMessagesError: "Impossible de charger les messages",
    uploadFileError: "Upload fichier impossible",
    serverError: "Erreur serveur",
    askHelpTitle: "Comment puis-je vous aider aujourd'hui ?",
    askHelpSubtitle: "Posez des questions sur vos documents ou discutez librement avec SmartIA.",
    analyzeDoc: "Analyser un document",
    analyzeDocHint: "Chargez un PDF puis posez des questions ciblÃ©es.",
    fullFile: "Donner un fichier complet",
    fullFileHint: "Demandez Â« donne-moi le fichier complet NOM_FICHIER Â».",
    attachedFiles: "Fichiers joints",
    sendMessage: "Envoyer un message...",
    createChatFirst: "CrÃ©ez un nouveau chat d'abord...",
    addFileAria: "Ajouter un fichier",

    accessTitle: "ðŸ”‘ AccÃ¨s",
    accessSubtitle: "CrÃ©er des utilisateurs et gÃ©rer tous les accÃ¨s.",
    addUser: "Ajouter un utilisateur",
    email: "Email",
    password: "Mot de passe",
    active: "Actif",
    add: "Ajouter",
    usersList: "Tous les utilisateurs",
    actions: "Actions",
    edit: "Modifier",
    changeRole: "Changer rÃ´le",
    enableAccess: "Activer accÃ¨s",
    disableAccess: "DÃ©sactiver accÃ¨s",
    yes: "Oui",
    no: "Non",
    accessConfirm: "Voulez-vous {action} l'accÃ¨s de {email} ?",
    rolePrompt: "Nouveau rÃ´le: member/admin/visitor",
    emailPrompt: "Nouvel email",
    deleteUserConfirm: "Supprimer {email} ?",

    filesManagement: "Gestion des fichiers (RAG)",
    refresh: "Actualiser",
    loading: "Chargement...",
    file: "Fichier",
    visibility: "VisibilitÃ©",
    sizeBytes: "Taille (bytes)",
    updatedAt: "Mis Ã  jour",
    noFilesFound: "Aucun fichier trouvÃ©.",
    renameFilePrompt: "Nouveau nom du fichier",
    deleteFileConfirm: "Supprimer le fichier {filename} ?",
  },
  en: {
    menuToggle: "Open/Close menu",
    rag: "RAG",
    chat: "Chat",
    darkMode: "Dark mode",
    lightMode: "Light mode",
    roleAdmin: "ADMIN",
    roleMember: "MEMBER",
    language: "Language",

    newChat: "New chat",
    creating: "Creating...",
    searchChat: "Search chats",
    yourChats: "YOUR CHATS",
    rename: "Rename",
    delete: "Delete",
    deleteChatConfirm: "Delete this chat?",
    newTitlePrompt: "New title",
    uploadImpossible: "Upload failed",
    uploadDoneIn: "File uploaded in",
    addFile: "Add file",
    uploadProgress: "Upload...",
    logout: "Logout",
    destinationPrompt: "Destination? Type public or private",
    destinationInvalid: "Invalid destination. Use public or private.",
    adminAccess: "Access",
    adminMembers: "Members",
    adminAdmins: "Admins",

    loadMessagesError: "Unable to load messages",
    uploadFileError: "File upload failed",
    serverError: "Server error",
    askHelpTitle: "How can I help you today?",
    askHelpSubtitle: "Ask questions about your documents or chat freely with SmartIA.",
    analyzeDoc: "Analyze a document",
    analyzeDocHint: "Upload a PDF and ask targeted questions.",
    fullFile: "Get full file",
    fullFileHint: "Ask: " + '"give me full file FILE_NAME"',
    attachedFiles: "Attached files",
    sendMessage: "Send a message...",
    createChatFirst: "Create a new chat first...",
    addFileAria: "Add file",

    accessTitle: "ðŸ”‘ Access",
    accessSubtitle: "Create users and manage all access.",
    addUser: "Add user",
    email: "Email",
    password: "Password",
    active: "Active",
    add: "Add",
    usersList: "All users",
    actions: "Actions",
    edit: "Edit",
    changeRole: "Change role",
    enableAccess: "Enable access",
    disableAccess: "Disable access",
    yes: "Yes",
    no: "No",
    accessConfirm: "Do you want to {action} access for {email}?",
    rolePrompt: "New role: member/admin/visitor",
    emailPrompt: "New email",
    deleteUserConfirm: "Delete {email}?",

    filesManagement: "File management (RAG)",
    refresh: "Refresh",
    loading: "Loading...",
    file: "File",
    visibility: "Visibility",
    sizeBytes: "Size (bytes)",
    updatedAt: "Updated at",
    noFilesFound: "No files found.",
    renameFilePrompt: "New file name",
    deleteFileConfirm: "Delete file {filename}?",
  },
  es: {
    menuToggle: "Abrir/Cerrar menÃº",
    rag: "RAG",
    chat: "Chat",
    darkMode: "Modo oscuro",
    lightMode: "Modo claro",
    roleAdmin: "ADMIN",
    roleMember: "MIEMBRO",
    language: "Idioma",
    newChat: "Nuevo chat",
    creating: "Creando...",
    searchChat: "Buscar chats",
    yourChats: "TUS CHATS",
    rename: "Renombrar",
    delete: "Eliminar",
    deleteChatConfirm: "Â¿Eliminar este chat?",
    newTitlePrompt: "Nuevo tÃ­tulo",
    uploadImpossible: "Subida imposible",
    uploadDoneIn: "Archivo subido en",
    addFile: "AÃ±adir archivo",
    uploadProgress: "Subiendo...",
    logout: "Cerrar sesiÃ³n",
    destinationPrompt: "Â¿Destino? Escriba public o private",
    destinationInvalid: "Destino invÃ¡lido. Use public o private.",
    adminAccess: "Acceso",
    adminMembers: "Miembros",
    adminAdmins: "Admins",
    loadMessagesError: "No se pueden cargar los mensajes",
    uploadFileError: "Error al subir archivo",
    serverError: "Error del servidor",
    askHelpTitle: "Â¿CÃ³mo puedo ayudarte hoy?",
    askHelpSubtitle: "Haz preguntas sobre tus documentos o conversa libremente con SmartIA.",
    analyzeDoc: "Analizar un documento",
    analyzeDocHint: "Sube un PDF y haz preguntas especÃ­ficas.",
    fullFile: "Obtener archivo completo",
    fullFileHint: "Pide: archivo completo NOMBRE_ARCHIVO.",
    attachedFiles: "Archivos adjuntos",
    sendMessage: "Enviar un mensaje...",
    createChatFirst: "Primero crea un nuevo chat...",
    addFileAria: "AÃ±adir archivo",
    accessTitle: "ðŸ”‘ Acceso",
    accessSubtitle: "Crear usuarios y gestionar todos los accesos.",
    addUser: "Agregar usuario",
    email: "Email",
    password: "ContraseÃ±a",
    active: "Activo",
    add: "Agregar",
    usersList: "Todos los usuarios",
    actions: "Acciones",
    edit: "Editar",
    changeRole: "Cambiar rol",
    enableAccess: "Activar acceso",
    disableAccess: "Desactivar acceso",
    yes: "SÃ­",
    no: "No",
    accessConfirm: "Â¿Quieres {action} el acceso de {email}?",
    rolePrompt: "Nuevo rol: member/admin/visitor",
    emailPrompt: "Nuevo email",
    deleteUserConfirm: "Â¿Eliminar {email}?",
    filesManagement: "GestiÃ³n de archivos (RAG)",
    refresh: "Actualizar",
    loading: "Cargando...",
    file: "Archivo",
    visibility: "Visibilidad",
    sizeBytes: "TamaÃ±o (bytes)",
    updatedAt: "Actualizado",
    noFilesFound: "No se encontraron archivos.",
    renameFilePrompt: "Nuevo nombre del archivo",
    deleteFileConfirm: "Â¿Eliminar archivo {filename}?",
  },
  ar: {
    menuToggle: "ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©",
    rag: "RAG",
    chat: "Ø¯Ø±Ø¯Ø´Ø©",
    darkMode: "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†",
    lightMode: "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­",
    roleAdmin: "Ù…Ø´Ø±Ù",
    roleMember: "Ø¹Ø¶Ùˆ",
    language: "Ø§Ù„Ù„ØºØ©",
    newChat: "Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©",
    creating: "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...",
    searchChat: "Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª",
    yourChats: "Ù…Ø­Ø§Ø¯Ø«Ø§ØªÙƒ",
    rename: "Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ©",
    delete: "Ø­Ø°Ù",
    deleteChatConfirm: "Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ",
    newTitlePrompt: "Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯",
    uploadImpossible: "ØªØ¹Ø°Ø± Ø§Ù„Ø±ÙØ¹",
    uploadDoneIn: "ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù ÙÙŠ",
    addFile: "Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù",
    uploadProgress: "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...",
    logout: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬",
    destinationPrompt: "Ø§Ù„ÙˆØ¬Ù‡Ø©ØŸ Ø§ÙƒØªØ¨ public Ø£Ùˆ private",
    destinationInvalid: "ÙˆØ¬Ù‡Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©. Ø§Ø³ØªØ®Ø¯Ù… public Ø£Ùˆ private.",
    adminAccess: "Ø§Ù„ÙˆØµÙˆÙ„",
    adminMembers: "Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡",
    adminAdmins: "Ø§Ù„Ù…Ø´Ø±ÙÙˆÙ†",
    loadMessagesError: "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„",
    uploadFileError: "ØªØ¹Ø°Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù",
    serverError: "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…",
    askHelpTitle: "ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ",
    askHelpSubtitle: "Ø§Ø·Ø±Ø­ Ø£Ø³Ø¦Ù„Ø© Ø­ÙˆÙ„ Ù…Ø³ØªÙ†Ø¯Ø§ØªÙƒ Ø£Ùˆ ØªØ­Ø¯Ø« Ø¨Ø­Ø±ÙŠØ© Ù…Ø¹ SmartIA.",
    analyzeDoc: "ØªØ­Ù„ÙŠÙ„ Ù…Ø³ØªÙ†Ø¯",
    analyzeDocHint: "Ø­Ù…Ù‘Ù„ PDF Ø«Ù… Ø§Ø·Ø±Ø­ Ø£Ø³Ø¦Ù„Ø© Ø¯Ù‚ÙŠÙ‚Ø©.",
    fullFile: "Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ù„Ù ÙƒØ§Ù…Ù„Ù‹Ø§",
    fullFileHint: "Ø§Ø·Ù„Ø¨: Ø§Ù„Ù…Ù„Ù Ø§Ù„ÙƒØ§Ù…Ù„ Ø§Ø³Ù…_Ø§Ù„Ù…Ù„Ù.",
    attachedFiles: "Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø©",
    sendMessage: "Ø£Ø±Ø³Ù„ Ø±Ø³Ø§Ù„Ø©...",
    createChatFirst: "Ø£Ù†Ø´Ø¦ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø£ÙˆÙ„Ù‹Ø§...",
    addFileAria: "Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù",
    accessTitle: "ðŸ”‘ Ø§Ù„ÙˆØµÙˆÙ„",
    accessSubtitle: "Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ¥Ø¯Ø§Ø±Ø© ÙƒÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØµÙˆÙ„.",
    addUser: "Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…",
    email: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
    password: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
    active: "Ù†Ø´Ø·",
    add: "Ø¥Ø¶Ø§ÙØ©",
    usersList: "ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†",
    actions: "Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª",
    edit: "ØªØ¹Ø¯ÙŠÙ„",
    changeRole: "ØªØºÙŠÙŠØ± Ø§Ù„Ø¯ÙˆØ±",
    enableAccess: "ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„",
    disableAccess: "ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„",
    yes: "Ù†Ø¹Ù…",
    no: "Ù„Ø§",
    accessConfirm: "Ù‡Ù„ ØªØ±ÙŠØ¯ {action} ÙˆØµÙˆÙ„ {email}ØŸ",
    rolePrompt: "Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯: member/admin/visitor",
    emailPrompt: "Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¬Ø¯ÙŠØ¯",
    deleteUserConfirm: "Ø­Ø°Ù {email}ØŸ",
    filesManagement: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª (RAG)",
    refresh: "ØªØ­Ø¯ÙŠØ«",
    loading: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...",
    file: "Ø§Ù„Ù…Ù„Ù",
    visibility: "Ø§Ù„Ø¸Ù‡ÙˆØ±",
    sizeBytes: "Ø§Ù„Ø­Ø¬Ù… (Ø¨Ø§ÙŠØª)",
    updatedAt: "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«",
    noFilesFound: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª.",
    renameFilePrompt: "Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯",
    deleteFileConfirm: "Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù {filename}ØŸ",
  },
};

const LanguageContext = createContext(null);

function format(template, params) {
  return template.replace(/\{(\w+)\}/g, (_, k) => params?.[k] ?? `{${k}}`);
}

export function LanguageProvider({ children }) {
  const [lang, setLang] = useState(localStorage.getItem(STORAGE_KEY) || "fr");

  useEffect(() => {
    localStorage.setItem(STORAGE_KEY, lang);
    document.documentElement.setAttribute("lang", lang);
    document.documentElement.setAttribute("dir", lang === "ar" ? "rtl" : "ltr");
  }, [lang]);

  const value = useMemo(() => ({
    lang,
    setLang,
    t: (key, params) => {
      const dict = messages[lang] || messages.fr;
      const fallback = messages.fr;
      const text = dict[key] ?? fallback[key] ?? key;
      return typeof text === "string" ? format(text, params) : String(text);
    },
  }), [lang]);

  return <LanguageContext.Provider value={value}>{children}</LanguageContext.Provider>;
}

export function useI18n() {
  const ctx = useContext(LanguageContext);
  if (!ctx) {
    throw new Error("useI18n must be used within a LanguageProvider");
  }
  return ctx;
}